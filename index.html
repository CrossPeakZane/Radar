<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Animation with Overlay</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #f5f5f5;
        }

        #animationContainer {
            margin: 0 auto;
            max-width: 100%;
            overflow: hidden;
        }

        #animationCanvas {
            width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #dateInputs {
            margin-top: 20px;
            text-align: center;
        }

        input[type="date"] {
            font-size: 16px;
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            font-size: 16px;
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="animationContainer">
        <canvas id="animationCanvas" width="800" height="600"></canvas>
    </div>
    <div id="dateInputs">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
        <br>
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
        <br>
        <button id="generateButton">Generate Animation</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const animationCanvas = document.getElementById('animationCanvas');
        const generateButton = document.getElementById('generateButton');

        async function playAnimationWithOverlay(images) {
            console.log('Playing animation with overlay...');

            const animationDuration = 50; // Faster animation duration (in milliseconds)
            const ctx = animationCanvas.getContext('2d');
            const canvasWidth = animationCanvas.width;
            const canvasHeight = animationCanvas.height;

            let currentFrameIndex = 0;

            const map = L.map('animationCanvas', {
                center: [37.8, -96],
                zoom: 4,
                attributionControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            function animate() {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);

                // Draw radar image
                ctx.drawImage(images[currentFrameIndex], 0, 0, canvasWidth, canvasHeight);

                currentFrameIndex = (currentFrameIndex + 1) % images.length;

                setTimeout(animate, animationDuration);
            }

            animate();
        }

        async function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = url;
                img.onload = () => resolve(img);
                img.onerror = (error) => reject(error);
            });
        }

        async function loadAndPlayAnimation(startDate, endDate) {
            console.log('Loading radar images...');

            const loadingBar = document.createElement('div');
            loadingBar.style.position = 'fixed';
            loadingBar.style.top = '0';
            loadingBar.style.left = '0';
            loadingBar.style.width = '0';
            loadingBar.style.height = '5px';
            loadingBar.style.background = '#007bff';
            loadingBar.style.transition = 'width 0.5s';
            document.body.appendChild(loadingBar);

            console.log('Start Date:', startDate);
            console.log('End Date:', endDate);

            const totalHours = Math.abs((endDate - startDate) / 36e5);

            const images = [];

            for (let i = 0; i <= totalHours; i++) {
                const currentHour = new Date(startDate);
                currentHour.setHours(currentHour.getHours() + i);

                const formattedHour = String(currentHour.getUTCHours()).padStart(2, '0');
                const formattedYear = currentHour.getUTCFullYear();
                const formattedMonth = String(currentHour.getUTCMonth() + 1).padStart(2, '0');
                const formattedDay = String(currentHour.getUTCDate()).padStart(2, '0');

                const radarUrl = `https://mesonet.agron.iastate.edu/archive/data/${formattedYear}/${formattedMonth}/${formattedDay}/GIS/uscomp/n0q_${formattedYear}${formattedMonth}${formattedDay}${formattedHour}00.png`;

                console.log('Loading:', radarUrl);

                try {
                    const img = await loadImage(radarUrl);
                    images.push(img);
                    loadingBar.style.width = `${(i / totalHours) * 100}%`;
                } catch (error) {
                    console.error('Failed to load image:', radarUrl, error);
                }
            }

            loadingBar.style.display = 'none';
            playAnimationWithOverlay(images);
        }

        generateButton.addEventListener('click', async () => {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            loadAndPlayAnimation(startDate, endDate);
        });

        // Initial load with default dates
        //loadAndPlayAnimation(new Date('2018-09-14T00:00:00Z'), new Date('2018-09-14T23:00:00Z'));
    </script>
</body>
</html>